- route:
    id: main
    from:
      uri: kafka
      parameters:
        topic: "{{kafka.topic}}"
        brokers: my-cluster-kafka-bootstrap:9092
      steps:
        - bean:
            method: newMessage
            ref: controller
        - filter:
            expression:
              simple:
                expression: "${bean:controller?method=isTimeWindowExpired}"
            steps:
              - log:
                  message: "time window closed, ignoring event: ${body}"
              - stop: {}
        - log:
            message: "got new message: ${body}"
        - unmarshal:
            json: {}
        - marshal:
            csv: {}
        - aggregate:
            steps:
              - bean:
                  method: aggregationDone
                  ref: controller
              - to:
                  uri: direct
                  parameters:
                    name: archive-data
            aggregationStrategy: "msgStrategy"
            completionTimeout: "{{message.aggregator.timeout}}"
            correlationExpression:
              constant:
                expression: "true"
- route:
    id: keep-alive
    from:
      uri: direct
      parameters:
        name: wait-until-aggregation-done
      steps:
        - log:
            message: waiting for aggregation to finish...
        - bean:
            method: waitUntilAggregationDone
            ref: controller
        - log:
            message: Aggregation has completed.
- route:
    id: archive-data
    from:
      uri: direct
      parameters:
        name: archive-data
      steps:
        - log:
            message: "ready to archive aggregated data:\\n${body}"
        - log:
            message: archiving done.

        - setHeader:
            name: CamelAwsS3Key
            simple:
              expression: myroom/${date:now:yyyy-MM-dd_HH-mm-ssZ}.csv
        - setHeader:
            name: CamelAwsS3ContentType
            constant:
              expression: text/csv
        - to:
            uri: aws2-s3
            parameters:
              bucketNameOrArn: chatrooms-user3
