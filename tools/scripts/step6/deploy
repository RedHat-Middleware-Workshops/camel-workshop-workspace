#!/bin/bash
set -euo pipefail

# Load common variables
echo "Running step 6 deployment"

# Ensure work is done from lab directory
cd /projects/workshop/lab

# Get user
# don't use 'oc whoami' so that admins can run this script
USER=$(echo "$DEVWORKSPACE_NAMESPACE" | sed 's/-devspaces$//')

info "Preparing configuration..."



# ========================================
# Prepare configuration properties
# ========================================

# Where to call (change namespace if needed)
DOCSERVER_URL="http://docserver.webapp.svc:80"

# Fetch token,userId in one shot
# echo "Fetching Rocket.Chat credentials from $DOCSERVER_URL ..."
RESPONSE=$(curl -sSf "$DOCSERVER_URL/configuration/rocketchat/$USER")   # -s silent, -S show errors, -f fail on HTTP errors

# echo "response was: $RESPONSE"

# Split the response on the comma
IFS=',' read -r ROCKETCHAT_TOKEN ROCKETCHAT_USERID <<< "$RESPONSE"

# Sanity check
if [[ -z "$ROCKETCHAT_TOKEN" || -z "$ROCKETCHAT_USERID" ]]; then
  echo "ERROR: Invalid response from docserver: '$RESPONSE'" >&2
  exit 1
fi

# echo "Got token: ${ROCKETCHAT_TOKEN:0:10}... and userId: $ROCKETCHAT_USERID"


# Fetch token,userId in one shot
# echo "Fetching Matrix credentials from $DOCSERVER_URL ..."
RESPONSE=$(curl -sSf "$DOCSERVER_URL/configuration/matrix/$USER")   # -s silent, -S show errors, -f fail on HTTP errors

# echo "response was: $RESPONSE"

# Split the response on the comma
IFS=',' read -r MATRIX_TOKEN MATRIX_ROOM <<< "$RESPONSE"

# Sanity check
if [[ -z "$MATRIX_TOKEN" || -z "$MATRIX_ROOM" ]]; then
  echo "ERROR: Invalid response from docserver: '$RESPONSE'" >&2
  exit 1
fi

# echo "Got token: $MATRIX_TOKEN and userId: $MATRIX_ROOM"

cat > matrix.properties <<EOF
# Matrix credentials
matrix.token=$MATRIX_TOKEN
matrix.room=$MATRIX_ROOM
EOF

cat > rocketchat.properties <<EOF
# Rocket.Chat credentials
rocketchat.token=$ROCKETCHAT_TOKEN
rocketchat.userid=$ROCKETCHAT_USERID
EOF

info "Property files ready."

# m2k deployment
if oc get deploy m2k &> /dev/null; then
  info "[m2k] already deployed – skipping"
else
  info "Deploying m2k..."
  labdeploy m2k matrix.properties
  info "[m2k] Ready"
fi

# k2m deployment
if oc get deploy k2m &> /dev/null; then
  info "[k2m] already deployed – skipping"
else
  info "Deploying k2m..."
  labdeploy k2m matrix.properties
  info "[k2m] Ready"
fi

# r2k deployment
if oc get deploy r2k &> /dev/null; then
  info "[r2k] already deployed – skipping"
else
  info "Deploying r2k..."
  labdeploy r2k rocketchat.properties
  info "[r2k] Ready"
fi

# k2r deployment
if oc get deploy k2r &> /dev/null; then
  info "[k2r] already deployed – skipping"
else
  info "Deploying k2r..."
  labdeploy k2r rocketchat.properties
  info "[k2r] Ready"
fi

info "All done."